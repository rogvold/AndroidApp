package com.cardiomood.math.spectrum;

import com.cardiomood.math.HeartRateMath;

import org.apache.commons.math3.analysis.UnivariateFunction;
import org.apache.commons.math3.analysis.interpolation.SplineInterpolator;
import org.apache.commons.math3.complex.Complex;
import org.apache.commons.math3.stat.StatUtils;
import org.apache.commons.math3.transform.DftNormalization;
import org.apache.commons.math3.transform.FastFourierTransformer;
import org.apache.commons.math3.transform.TransformType;

/**
 * Created by danon on 21.02.14.
 */
public class FFT {

    private final double[] t;
    private final double[] y;

    private Complex[] result;
    private int n = 0;
    private final double duration;

    public FFT(double t[], double y[]) {
        this.t = t;
        this.y = y;
        duration = t[t.length-1] - t[0];
        n = 1;
        int k = (int) Math.ceil(duration/1000);
        while (n < k)
            n <<= 1;

        result = transform(t, y, 0, t.length, n);
    }

    public double toFrequency(int i) {
        return ((double)i)/duration*1000;
    }

    public double[] getPower() {
        double[] result = new double[n/2];
        for (int i=0; i<result.length; i++) {
            result[i] = this.result[i].abs()/n;
            result[i] *= result[i];
        }
        return result;
    }

    public static Complex[] transform(double[] x, double[] y, int begin, int length, int n) {
        FastFourierTransformer fft = new FastFourierTransformer(DftNormalization.STANDARD);
        double a[] = new double[length];
        double b[] = new double[length];
        System.arraycopy(x, begin, a, 0, length);
        System.arraycopy(y, begin, b, 0, length);

        double m = StatUtils.mean(b);
        for (int i=0; i<b.length; i++)
            b[i] -= m;

        SplineInterpolator spline = new SplineInterpolator();
        UnivariateFunction f = spline.interpolate(a, b);
        return fft.transform(f, x[begin], x[begin+length-1], n, TransformType.FORWARD);
    }

    public static void main(String[] args) {
        long t = System.currentTimeMillis();
        double[] intervals = new double[] {
                695,710,710,703,710,679,695,664,687,656,671,679,710,703,726,718,710,718,734,695,710,726,718,710,703,710,703,726,703,710,703,726,695,718,710,718,726,710,710,718,695,695,703,695,718,726,734,718,750,734,734,710,718,726,710,718,703,710,687,687,679,679,679,671,664,640,648,632,640,656,656,664,703,703,726,757,757,750,726,734,687,695,679,679,664,679,695,695,679,671,656,648,664,671,679,718,710,742,726,710,679,664,664,640,617,617,617,625,625,664,687,695,695,718,718,718,718,742,726,710,679,687,687,726,718,710,703,710,695,679,671,671,656,632,640,617,632,656,687,718,757,773,789,765,757,742,757,734,742,742,710,726,687,671,640,632,640,664,664,656,671,679,656,656,625,640,625,609,609,601,609,585,585,562,578,570,539,554,539,562,554,546,554,554,585,585,617,617,640,656,671,656,664,664,640,648,671,664,648,656,625,632,617,617,632,617,625,601,609,593,593,570,593,570,578,585,585,609,648,664,671,679,679,687,664,679,656,671,664,679,656,656,640,640,609,617,601,593,570,593,609,625,679,687,718,726,742,734,726,726,718,726,679,703,718,710,710,687,664,664,648,648,648,656,671,687,687,671,664,679,664,671,671,687,671,656,656
        };
//        double intervals[] = new double[] {
//                672, 461, 862, 632, 622, 636, 634, 629, 613, 602, 594, 583, 575, 569, 584, 606, 700, 669, 639, 666, 777, 802, 734, 841, 812, 855, 887, 874, 766, 716, 709, 676, 650, 638, 640, 695, 1098, 882, 876, 794, 741, 724, 687, 658, 642, 643, 652, 696, 872, 730, 672, 761, 899, 1058, 1024, 953, 791, 720, 717, 753, 971, 805, 844, 810, 718, 696, 696, 741, 847, 776, 733, 788, 855, 871, 838, 720, 742, 935, 887, 831, 783, 781, 833, 900, 1139, 1042, 884, 783, 801, 887, 1091, 986, 998, 1039, 1212, 983, 850, 807, 767, 735, 748, 816, 749, 1242, 1179, 1123, 946, 912, 761, 708, 743, 713, 687, 687, 695, 694, 1282, 1141, 1102, 982, 836, 805, 735, 692, 761, 1393, 1105, 1147, 1061, 940, 825, 788, 885, 1297, 1046, 913, 904, 942, 1034, 822, 840, 1259, 1286, 1266, 1145, 1007, 872, 869, 875, 801, 836, 888, 928, 897, 847, 850, 767, 729, 748, 736, 726, 698, 683, 679, 677, 674, 695, 709, 744, 701, 687, 709, 723, 778, 805, 787, 744, 778, 736, 718, 748, 731, 799, 788, 714, 689, 778, 838, 818, 697, 694, 676, 707, 714, 736, 720, 734, 708, 690, 694, 721, 866, 1023, 883, 896, 891, 809, 755, 893, 830, 964, 1082, 945, 800, 753, 743, 779, 809, 791, 830, 863, 826, 868, 883, 814, 798, 833, 787, 819, 836, 803, 780, 752, 726, 699, 695, 709, 727, 734, 732, 734, 711, 698, 677, 708, 750, 785, 828, 834, 735, 712, 721, 760, 754, 766, 853, 858, 837, 875, 875, 811, 813, 892, 892, 847, 886, 886, 857, 894, 927, 910, 967, 1163, 995, 957, 859, 852, 995, 1087, 1128, 1146, 894, 936, 907, 920, 865, 908, 911, 892, 944, 989, 940, 909, 905, 843, 858, 823, 778, 869, 988, 1023, 990, 1008, 910, 890, 912, 868, 837, 917, 968, 967, 905, 912, 822, 810, 721, 706, 741, 818, 901, 1154, 933, 892, 961, 1019, 1031, 1144, 1101, 864, 823, 781, 808, 824, 854, 953, 903, 895, 875, 879, 858, 771, 712, 682, 694, 723, 1124, 852, 953, 945, 884, 788, 757, 784, 787, 848, 963, 979, 961, 865, 712, 700, 692, 748, 1189, 938, 796, 745, 718, 768, 867, 945, 829, 863, 899, 904, 931, 925, 825, 872, 885, 895, 859, 928, 903, 859, 899, 883, 837, 875, 924, 864, 878, 892, 828, 827, 808, 755, 849, 879, 875, 791, 820, 815, 773, 739, 714, 710, 690, 706, 747, 1064, 833, 841, 856, 868, 833, 833, 844, 807, 747, 768, 833, 811, 775, 898, 833, 781, 826, 864, 807, 826, 892, 832, 826, 879, 906, 850, 827, 822, 791, 778, 829, 825, 876, 862, 889, 818, 810, 775, 730, 731, 716, 768, 809, 884, 937, 856, 762, 775, 768, 767, 800, 846, 896, 841, 875, 873, 819, 834, 817, 835, 821, 841, 895, 883, 859, 912, 861, 837, 846, 840, 778, 764, 782, 833, 720, 695, 760, 1043, 1036, 931, 774, 761, 800, 827, 791, 804, 842, 795, 811, 800, 811, 809, 834, 809, 755, 755, 803, 768, 755, 774, 800, 771, 777, 794, 768, 776, 805, 897, 834, 840, 799, 759, 784, 833, 844, 868, 827, 755, 686, 678, 720, 1073, 955, 991, 990, 873, 836, 840, 775, 833, 1053, 972, 877, 887, 887, 833, 820, 751, 746, 768, 814, 833, 858, 973, 921, 885, 875, 934, 867, 922, 967, 898, 905, 953, 897, 848, 892, 888, 810, 878, 873, 817, 811, 760, 724, 693, 709, 734, 749, 733, 750, 776, 740, 756, 781, 781, 759, 772, 759, 739, 841, 961, 913, 789, 782, 819, 789, 799, 852, 839, 801, 806, 847, 764, 741, 759, 807, 800, 772, 777, 748, 718, 723, 786, 777, 791, 862, 864, 780, 751, 750, 779, 772, 851, 911, 843, 832, 893, 860, 811, 839, 861, 820, 877, 886, 855, 745, 683, 670, 680, 723, 776, 797, 883, 911, 771, 760, 733, 764, 809, 800, 765, 788, 776, 797, 892, 875, 833, 810, 773, 843, 820, 786, 848, 792, 807, 850, 873, 867, 784, 742, 740, 731, 736, 776, 807, 823, 883, 825, 780, 802, 783, 778, 766, 780, 750, 743, 731, 784, 791, 843, 888, 845, 787, 750, 740, 765, 742, 725, 790, 821, 800, 891, 905, 878, 854, 857, 831, 849, 884, 819, 827, 898, 937, 915, 851, 861, 874, 914, 820, 805, 773, 744, 791, 864, 843, 818, 776, 739, 770, 906, 851, 882, 908, 873, 859, 918, 945, 901, 922, 867, 764, 707, 711, 907, 1243, 1066, 904, 878, 882, 864, 875, 902, 889, 878, 767, 779, 754, 701, 708, 708, 713, 714, 718, 694, 715, 740, 845, 995, 994, 874, 840, 875, 803, 986, 1006, 1012, 1028, 930, 835, 815, 750, 783, 777, 789, 1245, 982, 826, 791, 740, 710, 722, 725, 734, 739, 752, 727, 726, 730, 740, 741, 749, 766, 794, 923, 1152, 947, 809, 816, 788, 848, 818, 794, 777, 728, 823, 969, 870, 875, 835, 839, 790, 760, 731, 731, 753, 818, 836, 1002, 863, 913, 874, 823, 870, 864, 829, 799, 793, 738, 735, 754, 818, 793, 841, 937, 891, 800, 777, 757, 750, 790, 907, 963, 838, 875, 875, 826, 873, 897, 846, 862, 863, 824, 805, 783, 747, 750, 744, 737, 728, 731, 818, 859, 792, 780, 759, 728, 733, 737, 748, 805, 785, 744, 747, 753, 775, 754, 746, 755, 765, 747, 771, 796, 893, 838, 828, 838, 833, 786, 848, 844, 778, 776, 773, 835, 821, 786, 727, 702, 694, 714, 748, 698, 717, 771, 1007, 786, 814, 796, 750, 721, 691, 743, 845, 965, 925, 916, 799, 784, 834, 952, 924, 789, 721, 726, 747, 738, 765, 895, 1006, 1115, 1046, 884, 774, 703, 699, 710, 751, 805, 916, 1063, 901, 890, 857, 799, 732, 742, 787, 791, 812, 882, 923, 847, 844, 883, 839, 824, 939, 885, 941, 928, 869, 888, 892, 851, 864, 885, 864, 846, 888, 891, 838, 820, 790, 773, 782, 780, 834, 802, 812, 797, 780, 757, 749, 774, 761, 713, 694, 674, 682, 803, 871, 919, 885, 847, 804, 765, 768, 775, 779, 836, 804, 786, 828, 859, 828, 818, 886, 834, 779, 776, 815, 769, 770, 799, 846, 852, 928, 851, 858, 850, 811, 770, 737, 765, 830, 904, 899, 877, 818, 778, 785, 828, 875, 960, 991, 1050, 949, 916, 931, 874, 866, 902, 905, 855, 910, 961, 871, 875, 880, 833, 757, 747, 748, 760, 731, 780, 793, 792, 783, 844, 847, 866, 890, 858, 844, 918, 862, 841, 771, 712, 700, 743, 1132, 1147, 1089, 1016, 894, 910, 884, 916, 1056, 1018, 1071, 1020, 874, 793, 791, 772, 729, 729, 700, 726, 785, 803, 822, 831, 768, 747, 745, 724, 686, 705, 697, 688, 678, 696, 727, 704, 714, 789, 756, 731, 738, 733, 713, 728, 763, 737, 755, 806, 903, 824, 876, 873, 808, 807, 807, 778, 781, 848, 794, 758, 823, 833, 753, 749, 710, 787, 930, 785, 783, 798, 830, 768, 774, 793, 789, 817, 930, 880, 858, 855, 865, 833, 868, 888, 817, 882, 880, 842, 855, 904, 932, 891, 884, 875, 847, 809, 747, 747, 791, 817, 896, 916, 806, 843, 829, 800, 836, 823, 803, 826, 809, 766, 732, 742, 775, 768, 775, 825, 838, 788, 814, 822, 807, 765, 779, 791, 741, 729, 742, 773, 794, 769, 787, 812, 828, 796, 782, 785, 785, 726, 738, 767, 811, 797, 847, 949, 848, 837, 829, 783, 727, 727, 751, 769, 785, 1003, 914, 875, 884, 770, 779, 809, 874, 839, 925, 1083, 948, 908, 913, 894, 829, 875, 912, 926, 945, 1092, 1003, 865, 746, 697, 681, 733, 807, 1171, 1063, 953, 839, 810, 787, 811, 1081, 997, 925, 963, 861, 781, 782, 784, 750, 759, 755, 799, 779, 791, 858, 869, 833, 803, 796, 767, 771, 781, 739, 757, 809, 869, 834, 815, 804, 768, 716, 724, 750, 777, 803, 868, 889, 712, 719, 818, 1048, 1114, 1022, 866, 796, 724, 744, 786, 857, 1041, 966, 954, 886, 851, 795, 749, 765, 832, 923, 975, 933, 865, 855, 870, 863, 791, 815, 879, 909, 878, 944, 878, 871, 864, 819, 812, 831, 882, 833, 705, 710, 759, 945, 916, 882, 841, 855, 844, 775, 797, 793, 811, 901, 938, 898, 836, 787, 785, 794, 761, 744, 774, 834, 773, 810, 795, 730, 729, 782, 781, 738, 743, 742, 760, 786, 767, 786, 897, 900, 852, 890, 904, 852, 874, 913, 911, 870, 886, 888, 851, 836, 873, 904, 855, 910, 922, 866, 875, 858, 792, 841, 857, 831, 846, 920, 909, 858, 847, 806, 788, 771, 812, 906, 924, 1019, 875, 823, 814, 750, 735, 775, 825, 766, 745, 707, 709, 765, 764, 781, 853, 874, 775, 745, 744, 782, 797, 799, 850, 862, 815, 800, 829, 952, 833, 863, 898, 884, 921, 925, 906, 870, 887, 895, 849, 867, 862, 856, 855, 935, 988, 936, 921, 897, 842, 828, 901, 952, 954, 947, 956, 894, 910, 913, 871, 895, 922, 899, 848, 865, 829, 839, 823, 920, 851, 836, 834, 797, 937, 868, 858, 848, 838, 806, 787, 794, 970, 930, 926, 926, 903, 829, 831, 830, 807, 770, 813, 861, 902, 836, 816, 832, 758, 746, 738, 722, 741, 747, 814, 830, 740, 730, 723, 705, 704, 725, 804, 831, 748, 732, 759, 745, 737, 800, 862, 793, 803, 797, 764, 752, 752, 908, 778, 730, 712, 699, 700, 695, 735, 718, 723, 802, 873, 797, 790, 750, 712, 715, 708, 700, 706, 768, 787, 780, 782, 731, 712, 702, 721, 721, 739, 738, 718, 724, 708, 709, 750, 790, 776, 802, 863, 884, 797, 794, 939, 799, 772, 752, 868, 967, 908, 836, 868, 875, 855, 792, 774, 750, 754, 814, 1173, 1115, 920, 916, 916, 887, 906, 916, 889, 960, 922, 825, 807, 743, 797, 1122, 1156, 1149, 1089, 892, 898, 900, 857, 921, 998, 1084, 1055, 1066, 873, 900, 911, 819, 835, 1020, 950, 898, 976, 1000, 1081, 989, 923, 831, 788, 805, 896, 1054, 978, 965, 871, 784, 818, 813, 760, 802, 812, 859, 818, 807, 761, 756, 740, 754, 725, 742, 746, 764, 749, 750, 822, 818, 766, 775, 779, 761, 756, 786, 900, 916, 894, 853, 829, 859, 895, 900, 875, 871, 886, 840, 838, 861, 877, 844, 818, 840, 926, 827, 819, 774, 778, 723, 728, 766, 826, 891, 902, 851, 830, 809, 763, 753, 737, 791, 891, 949, 973, 1050, 986, 858, 818, 820, 898, 886, 930, 965, 981, 928, 931, 889, 851, 880, 886, 839, 799, 834, 943, 900, 830, 883, 859, 883, 929, 909, 917, 915, 900, 850, 864, 867, 796, 875, 952, 941, 958, 922, 851, 787, 748, 764, 805, 929, 946, 1037, 1012, 929, 783, 728, 689, 680, 669, 656, 668, 683, 707, 762, 854, 894, 748, 730, 733, 763, 754, 762, 798, 859, 788, 854, 917, 878, 822, 866, 915, 814, 800, 804, 778, 736, 730, 706, 784, 917, 921, 953, 915, 878, 879, 825, 773, 772, 861, 889, 928, 962, 966, 978, 958, 900, 955, 899, 918, 928, 907, 916, 942, 922, 974, 1016, 983, 926, 887, 836, 754, 830, 1058, 1035, 1017, 991, 1033, 953, 932, 937, 856, 892, 900, 836, 934, 902, 868, 931, 927, 791, 713, 696, 763, 995, 960, 961, 926, 889, 897, 913, 898, 891, 890, 894, 864, 908, 974, 976, 953, 938, 817, 785, 727, 750, 1067, 862, 874, 894, 891, 983, 1169, 1139, 1045, 900, 784, 764, 834, 1217, 966, 747, 681, 666, 657, 629, 633, 623, 626, 612, 603, 601, 594, 585, 574, 573, 566, 561, 558, 554, 543, 559, 578, 587, 602, 628, 724, 1037, 974, 960, 902, 894, 809, 779, 770, 774, 757, 743, 708, 734, 758, 766, 821, 741, 738, 728, 666, 654, 644, 645, 627, 622, 621, 624, 617, 626, 621, 637, 631, 592, 617
//        };
        HeartRateMath hrm = new HeartRateMath(intervals);
        System.out.println(hrm.getDuration()/1000);
        SpectralAnalysis s = new SpectralAnalysis(hrm.getTime(), hrm.getRrIntervals());
        FFT fft = s.getFft();
        double[] spectrum = fft.getPower();
        for (int i=0; i<spectrum.length; i++) {
            System.out.println(fft.toFrequency(i)+ " " + spectrum[i]);
        }
        System.out.println();

        System.out.println("TP = " + s.getTP());
        System.out.println("ULF = " + s.getULF());
        System.out.println("VLF = " + s.getVLF());
        System.out.println("LF = " + s.getLF());
        System.out.println("HF = " + s.getHF());

        System.out.println(System.currentTimeMillis() - t);
    }

}
